{"version":3,"sources":["../../src/select.ts"],"sourcesContent":["import { CompoundQuery } from \"./compoundQuery.js\";\nimport { BaseQuery, Query } from \"./query.js\";\nimport { Where } from \"./where.js\";\n\n// Access the AliasGenerator from query.ts\nconst AliasGenerator = {\n  counter: 0,\n  generate(): string {\n    return `s${++this.counter}`;\n  }\n};\n\nexport class Select<T extends object> {\n  query: Query<T>;\n  fields: Partial<Record<keyof T, string>> = {};\n  subquery?: Query<any>;\n  subqueryAlias?: string;\n\n  constructor(query: Query<T>, fields: any, alias?: string) {\n    this.query = query;\n\n    // Check if fields is actually a Query (subquery)\n    if (fields && typeof fields === 'object' && 'select' in fields && typeof fields.select === 'function') {\n      this.subquery = fields as Query<any>;\n      this.subqueryAlias = alias || AliasGenerator.generate();\n      return;\n    }\n\n    if (Array.isArray(fields)) {\n      fields.forEach((field: keyof T) => {\n        this.fields[field] = field as string;\n      });\n      return;\n    }\n\n    if (fields && typeof fields === 'object') {\n      Object.entries(fields).forEach(([key, value]) => {\n        this.fields[key as keyof T] = value as string;\n      });\n    }\n    return;\n  }\n\n  private getSource(query: Query<any>): string {\n    if (query instanceof BaseQuery) {\n      return `${query.tableName} AS ${query.tableAlias}`;\n    } else if (query instanceof CompoundQuery) {\n      const left = this.getSource(query.query1);\n      const right = this.getSource(query.query2);\n      const on = Object.entries(query.joinInfo.condition || {})\n        .map(([key, value]) => {\n          // Get the rightmost table alias from the left side of the join\n          const leftAlias = this.getRightmostTableAlias(query.query1);\n          const rightAlias = this.getRightmostTableAlias(query.query2);\n          return `${leftAlias}.${String(key)} = ${rightAlias}.${String(value)}`;\n        })\n        .join(\" AND \");\n      const joinType = query.joinInfo.joinType;\n      return `${left} ${joinType} JOIN ${right} ON ${on}`;\n    } else if (query instanceof Where) {\n      return this.getSource(query.query);\n    }\n    return \"\";\n  }\n\n  private getRightmostTableAlias(query: Query<any>): string {\n    if (query instanceof BaseQuery) {\n      return query.tableAlias;\n    } else if (query instanceof CompoundQuery) {\n      // For compound queries, get the rightmost table alias (the most recently joined table)\n      return this.getRightmostTableAlias(query.query2);\n    } else if (query instanceof Where) {\n      return this.getRightmostTableAlias(query.query);\n    }\n    return \"\";\n  }\n\n  private formatCondition(key: string, value: any, tableAlias: string): string {\n    if (typeof value === 'object' && value !== null && !Array.isArray(value)) {\n      // Handle operators like $gt, $lt, etc.\n      const entries = Object.entries(value);\n      if (entries.length > 0) {\n        const [operator, operatorValue] = entries[0];\n        switch (operator) {\n          case '$eq': return `${tableAlias}.${key} = ${this.formatValue(operatorValue)}`;\n          case '$gt': return `${tableAlias}.${key} > ${this.formatValue(operatorValue)}`;\n          case '$lt': return `${tableAlias}.${key} < ${this.formatValue(operatorValue)}`;\n          case '$gte': return `${tableAlias}.${key} >= ${this.formatValue(operatorValue)}`;\n          case '$lte': return `${tableAlias}.${key} <= ${this.formatValue(operatorValue)}`;\n          case '$ne': return `${tableAlias}.${key} != ${this.formatValue(operatorValue)}`;\n          case '$in': return `${tableAlias}.${key} IN (${Array.isArray(operatorValue) ? operatorValue.map(v => this.formatValue(v)).join(', ') : this.formatValue(operatorValue)})`;\n          case '$like': return `${tableAlias}.${key} LIKE ${this.formatValue(operatorValue)}`;\n          default: return `${tableAlias}.${key} = ${this.formatValue(operatorValue)}`;\n        }\n      }\n    }\n    return `${tableAlias}.${key} = ${this.formatValue(value)}`;\n  }\n\n  private getWhereClause(query: Query<any>): string {\n    if (query instanceof Where) {\n      // Extract the inline \"or\" conditions from the main conditions\n      const { or: inlineOrConditions, ...mainConditions } = query.conditions;\n\n      // Process main conditions (excluding \"or\")\n      const conditions = Object.entries(mainConditions)\n        .map(([key, value]) => {\n          const tableAlias = this.getTableAliasForField(query, key);\n          return this.formatCondition(key, value, tableAlias);\n        })\n        .join(' AND ');\n\n      // Handle inline OR conditions\n      const inlineOrClauses = (inlineOrConditions || []).map(orCondition => {\n        const orClauses = Object.entries(orCondition)\n          .map(([key, value]) => {\n            const tableAlias = this.getTableAliasForField(query, key);\n            return this.formatCondition(key, value, tableAlias);\n          })\n          .join(' AND ');\n        return `(${orClauses})`;\n      });\n\n      // Handle chained OR conditions\n      const chainedOrConditions = query.orConditions.map(orCondition => {\n        const orClauses = Object.entries(orCondition.conditions)\n          .map(([key, value]) => {\n            const tableAlias = this.getTableAliasForField(query, key);\n            return this.formatCondition(key, value, tableAlias);\n          })\n          .join(' AND ');\n        return `(${orClauses})`;\n      });\n\n      // Combine all OR conditions\n      const allOrConditions = [...inlineOrClauses, ...chainedOrConditions];\n\n      let allConditions = conditions;\n      if (allOrConditions.length > 0) {\n        allConditions = allConditions ? `(${allConditions}) OR ${allOrConditions.join(' OR ')}` : allOrConditions.join(' OR ');\n      }\n\n      const nestedWhere = this.getWhereClause(query.query);\n      return nestedWhere ? `${allConditions} AND ${nestedWhere}` : allConditions;\n    }\n    return '';\n  }\n\n  private getTableAliasForField(query: Query<any>, _field: string): string {\n    // For now, just get the rightmost alias - in a more sophisticated implementation,\n    // you might want to track which table each field belongs to\n    return this.getRightmostTableAlias(query);\n  }\n\n  private formatValue(value: any): string {\n    if (typeof value === 'string') {\n      return `'${value}'`;\n    }\n    return String(value);\n  }\n\n  private generateSubquerySQL(query: Query<any>): string {\n    // Generate a basic SELECT * from the subquery to get its full SQL\n    if (query instanceof BaseQuery) {\n      return `SELECT * FROM ${query.tableName} AS ${query.tableAlias}`;\n    } else if (query instanceof CompoundQuery) {\n      const source = this.getSource(query);\n      return `SELECT * FROM ${source}`;\n    } else if (query instanceof Where) {\n      const source = this.getSource(query.query);\n      const whereClause = this.getWhereClause(query);\n      let sql = `SELECT * FROM ${source}`;\n      if (whereClause) {\n        sql += ` WHERE ${whereClause}`;\n      }\n      return sql;\n    }\n    return 'SELECT *';\n  }\n\n  toString() {\n    // Handle subquery case\n    if (this.subquery && this.subqueryAlias) {\n      const subquerySQL = this.generateSubquerySQL(this.subquery);\n      const source = this.getSource(this.query);\n      const whereClause = this.getWhereClause(this.query);\n\n      let sql = `SELECT (${subquerySQL}) AS ${this.subqueryAlias} FROM ${source}`;\n      if (whereClause) {\n        sql += ` WHERE ${whereClause}`;\n      }\n      return sql;\n    }\n\n    // Handle regular field selection\n    const fields = Object.entries(this.fields)\n      .map(([column, alias]) => {\n        if (column === alias) {\n          return column;\n        }\n        return `${column} AS ${alias}`;\n      })\n      .join(\", \");\n    const source = this.getSource(this.query);\n    const whereClause = this.getWhereClause(this.query);\n\n    let sql = `SELECT ${fields} FROM ${source}`;\n    if (whereClause) {\n      sql += ` WHERE ${whereClause}`;\n    }\n    return sql;\n  }\n}\n"],"names":["Select","AliasGenerator","counter","generate","getSource","query","BaseQuery","tableName","tableAlias","CompoundQuery","left","query1","right","query2","on","Object","entries","joinInfo","condition","map","key","value","leftAlias","getRightmostTableAlias","rightAlias","String","join","joinType","Where","formatCondition","Array","isArray","length","operator","operatorValue","formatValue","v","getWhereClause","or","inlineOrConditions","mainConditions","conditions","getTableAliasForField","inlineOrClauses","orCondition","orClauses","chainedOrConditions","orConditions","allOrConditions","allConditions","nestedWhere","_field","generateSubquerySQL","source","whereClause","sql","toString","subquery","subqueryAlias","subquerySQL","fields","column","alias","select","forEach","field"],"mappings":"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"}